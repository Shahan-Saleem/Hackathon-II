<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Task Manager</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>Task Manager Dashboard</h1>
            <div class="header-actions">
                <span id="welcomeMessage"></span>
                <button id="logoutBtn" class="btn btn-secondary">Logout</button>
            </div>
        </header>

        <div class="dashboard-content">
            <div class="projects-section">
                <div class="section-header">
                    <h2>Your Projects</h2>
                    <button id="newProjectBtn" class="btn btn-primary">New Project</button>
                </div>

                <div id="newProjectForm" class="form-container" style="display: none;">
                    <h3>Create New Project</h3>
                    <form id="createProjectForm">
                        <div class="form-group">
                            <label for="projectName">Project Name</label>
                            <input type="text" id="projectName" name="name" required>
                        </div>
                        <div class="form-group">
                            <label for="projectDescription">Description</label>
                            <textarea id="projectDescription" name="description"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Create Project</button>
                        <button type="button" id="cancelProjectBtn" class="btn btn-secondary">Cancel</button>
                    </form>
                </div>

                <div id="projectsList" class="projects-list">
                    <!-- Projects will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <script>
        // Check authentication status
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/me', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (!response.ok) {
                    window.location.href = '/login';
                    return;
                }

                const result = await response.json();
                document.getElementById('welcomeMessage').textContent = `Welcome, ${result.user.username}!`;
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = '/login';
            }
        }

        // Load projects
        async function loadProjects() {
            try {
                const response = await fetch('/api/projects', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to load projects');
                }

                const result = await response.json();
                const projectsContainer = document.getElementById('projectsList');

                if (result.projects.length === 0) {
                    projectsContainer.innerHTML = '<p>No projects yet. Create your first project!</p>';
                    return;
                }

                projectsContainer.innerHTML = '';
                result.projects.forEach(project => {
                    const projectElement = document.createElement('div');
                    projectElement.className = 'project-card';
                    projectElement.innerHTML = `
                        <h3>${project.name}</h3>
                        <p>${project.description || 'No description'}</p>
                        <div class="project-actions">
                            <button onclick="viewTasks('${project.id}')" class="btn btn-primary">View Tasks</button>
                            <button onclick="deleteProject('${project.id}')" class="btn btn-danger">Delete</button>
                        </div>
                    `;
                    projectsContainer.appendChild(projectElement);
                });
            } catch (error) {
                console.error('Error loading projects:', error);
                document.getElementById('projectsList').innerHTML = '<p>Error loading projects. Please refresh the page.</p>';
            }
        }

        // View tasks for a project
        function viewTasks(projectId) {
            window.location.href = `/tasks/${projectId}`;
        }

        // Create project
        async function createProject(formData) {
            try {
                const response = await fetch('/api/projects', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'credentials': 'include'
                    },
                    body: JSON.stringify(Object.fromEntries(formData))
                });

                const result = await response.json();

                if (response.ok) {
                    document.getElementById('createProjectForm').reset();
                    document.getElementById('newProjectForm').style.display = 'none';
                    loadProjects(); // Reload projects
                } else {
                    alert(result.error || 'Failed to create project');
                }
            } catch (error) {
                console.error('Error creating project:', error);
                alert('An error occurred while creating the project');
            }
        }

        // Delete project
        async function deleteProject(projectId) {
            if (!confirm('Are you sure you want to delete this project? All tasks will be deleted.')) {
                return;
            }

            try {
                const response = await fetch(`/api/projects/${projectId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (response.ok) {
                    loadProjects(); // Reload projects
                } else {
                    const result = await response.json();
                    alert(result.error || 'Failed to delete project');
                }
            } catch (error) {
                console.error('Error deleting project:', error);
                alert('An error occurred while deleting the project');
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadProjects();

            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', async function() {
                try {
                    await fetch('/api/auth/logout', {
                        method: 'POST',
                        credentials: 'include'
                    });
                    window.location.href = '/login';
                } catch (error) {
                    console.error('Logout failed:', error);
                    window.location.href = '/login';
                }
            });

            // New project button
            document.getElementById('newProjectBtn').addEventListener('click', function() {
                document.getElementById('newProjectForm').style.display = 'block';
            });

            // Cancel project button
            document.getElementById('cancelProjectBtn').addEventListener('click', function() {
                document.getElementById('newProjectForm').style.display = 'none';
                document.getElementById('createProjectForm').reset();
            });

            // Create project form
            document.getElementById('createProjectForm').addEventListener('submit', function(e) {
                e.preventDefault();
                createProject(new FormData(this));
            });
        });
    </script>
</body>
</html>